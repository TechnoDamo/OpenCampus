name: Render UML Diagrams

on:
  push:
    paths: ["docs/uml/*.puml"]
    branches: [main, master]
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: Render UML diagrams
        run: |
          mkdir -p docs/diagrams
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
          docker run --rm \
            -v "$PWD/docs:/docs" \
            plantuml/plantuml:latest \
            -tsvg "/docs/uml/*.puml" -o "/docs/diagrams"
          
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ SVG —Ñ–∞–π–ª—ã
          git add docs/diagrams/*.svg 2>/dev/null || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìä Auto-generated UML diagrams"
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è push
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
            git push origin HEAD:${{ github.ref }}
          fi